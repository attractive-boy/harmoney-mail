import router from '@ohos.router'
import { StyleConstants } from '@ohos/common'
import { ImageKnifeView } from '@ohos/common'
import { ToastUtil } from '@pura/harmony-utils'
import { addToCart } from '../../service/cartService'
import { queryGoodsDetail, queryStoreGoodsList, GoodsInfo } from '../../service/detailService'

@Entry
@Component
export struct Detail {
  @StorageProp('safeTop') safeTop: number = 0
  @StorageProp('safeBottom') safeBottom: number = 0

  @State goodsId: string = ''
  @State goods: GoodsInfo | null = null
  @State storeGoods: GoodsInfo[] = []
  @State isLoading: boolean = true
  @State loadError: string = ''
  @State currentImageIndex: number = 0

  aboutToAppear() {
    const params = router.getParams() as Record<string, string | number>
    const rawId = params?.goodsId
    this.goodsId = rawId === undefined || rawId === null ? '' : rawId.toString()
    if (this.goodsId) {
      this.loadDetail()
      this.loadStoreGoods()
    } else {
      this.isLoading = false
      this.loadError = 'æœªè·å–åˆ°å•†å“ä¿¡æ¯'
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        this.Header()
        Scroll() {
          Column() {
            if (this.isLoading) {
              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
                .padding(12)
            } else if (this.loadError) {
              Text(this.loadError)
                .fontSize(14)
                .fontColor('#666666')
                .padding(12)
            } else if (this.goods) {
              this.CarouselSection()
              this.PriceSection()
              this.PromoTabsSection()
              this.TitleDescSection()
              this.SpecificationSection()
              this.DeliverySection()
              this.ServiceSection()
              this.QuestionsSection()
              this.StoreSection()
              this.RecommendSection()
            }
          }
          .padding({ bottom: 70 + this.safeBottom })
        }
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')
      }
      .width(StyleConstants.FULL_WIDTH)
      .height(StyleConstants.FULL_HEIGHT)
      .backgroundColor('#F5F5F5')

      this.ActionBar()
    }
    .width(StyleConstants.FULL_WIDTH)
    .height(StyleConstants.FULL_HEIGHT)
  }

  @Builder
  Header() {
    Row() {
      Text('â†')
        .fontSize(20)
        .fontColor(Color.White)
        .onClick(() => router.back())
      Blank()
      Text('å•†å“è¯¦æƒ…')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(Color.White)
      Blank()
      Text('åˆ†äº«')
        .fontSize(12)
        .fontColor(Color.White)
    }
    .width(StyleConstants.FULL_WIDTH)
    .height(48 + this.safeTop)
    .padding({ left: 12, right: 12, top: this.safeTop })
    .alignItems(VerticalAlign.Center)
    .backgroundColor('#E53935')
  }

  @Builder
  CarouselSection() {
    Column() {
      Stack() {
        ImageKnifeView({
          loadSrc: this.goods?.imgUrl || '',
          objectFit: ImageFit.Fill
        })
        .width(StyleConstants.FULL_WIDTH)
        .height(280)

        // é¡¶éƒ¨æ ‡ç­¾
        Column() {
          Row() {
            Row() {
              Text('å®˜æ–¹éªŒè¯')
                .fontSize(9)
                .fontColor(Color.White)
                .padding({ left: 5, right: 5, top: 1, bottom: 1 })
                .borderRadius(8)
                .backgroundColor('#FF6A00')
            }
            .margin({ right: 4 })
          }
          Blank()
        }
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 10, top: 10 })
        .width(StyleConstants.FULL_WIDTH)
        .height(280)

        // å³ä¸‹è§’è®¡æ•°
        Column() {
          Blank()
          Text(`1/5`)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 5, right: 5, top: 2, bottom: 2 })
            .backgroundColor('#00000044')
            .borderRadius(10)
            .margin({ right: 10, bottom: 10 })
        }
        .alignItems(HorizontalAlign.End)
        .width(StyleConstants.FULL_WIDTH)
        .height(280)
      }
    }
    .backgroundColor(Color.White)
  }

  @Builder
  PriceSection() {
    if (!this.goods?.price || this.goods.price === '' || this.goods.price === '0') {
      // type=2 çš„æ¨å¹¿ç±»å•†å“ï¼Œæ²¡æœ‰ä»·æ ¼
      Column() {
        Row() {
          Column() {
            Text('æ´»åŠ¨å•†å“')
              .fontSize(18)
              .fontColor('#E53935')
              .fontWeight(FontWeight.Bold)
            Text('ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          Blank()
          Button('è¿›å…¥æ´»åŠ¨')
            .fontSize(12)
            .fontColor(Color.White)
            .backgroundColor('#E53935')
            .height(32)
            .padding({ left: 16, right: 16 })
        }
        .padding(12)
        .width(StyleConstants.FULL_WIDTH)
        .alignItems(VerticalAlign.Center)
      }
      .backgroundColor(Color.White)
    } else {
      Column() {
      // å¤§ä»·æ ¼åŒºåŸŸ
      Column() {
        Row() {
          Column() {
            Row() {
              Text('ï¿¥')
                .fontSize(14)
                .fontColor('#E53935')
                .fontWeight(FontWeight.Bold)
              Text((this.goods?.price || '0').split('.')[0])
                .fontSize(32)
                .fontColor('#E53935')
                .fontWeight(FontWeight.Bold)
              if ((this.goods?.price || '').includes('.')) {
                Text('.' + (this.goods?.price || '0').split('.')[1])
                  .fontSize(18)
                  .fontColor('#E53935')
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 4 })
              }
            }
            .alignItems(VerticalAlign.Center)

            Text('é™è´­3ä»¶/è´¦æˆ·  46äººå·²è´­')
              .fontSize(11)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          Blank()
        }
        .padding(12)
        .width(StyleConstants.FULL_WIDTH)
        .alignItems(VerticalAlign.Center)
      }
      .backgroundColor(Color.White)

      // ä¿ƒé”€ä¿¡æ¯
      Row() {
        Text('ğŸ')
          .fontSize(14)
          .margin({ right: 6 })
        Text('åœ¨çº¿è´­ä¹° ç«‹è¿”è´­ç‰©å¥–åŠ±  >')
          .fontSize(11)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(36)
      .backgroundColor('#4CAF50')
      .padding({ left: 12, right: 12 })
      .alignItems(VerticalAlign.Center)
      .margin({ top: 1 })

      // å…¶ä»–ä¿ƒé”€æ ‡ç­¾
      Row() {
        this.PromoBadge('é™æ—¶ä¼˜æƒ ')
        this.PromoBadge('é—¨åº—ä¼˜æƒ ')
        this.PromoBadge('å‡ä¸€èµ”ä¸‰')
      }
      .padding(10)
      .width(StyleConstants.FULL_WIDTH)
      .backgroundColor(Color.White)
      .margin({ top: 1 })
      }
    }
  }

  @Builder
  PromoBadge(text: string) {
    Row() {
      Text(text)
        .fontSize(10)
        .fontColor('#E53935')
    }
    .padding({ left: 6, right: 6, top: 3, bottom: 3 })
    .borderRadius(10)
    .border({ color: '#E53935', width: 0.5 })
    .margin({ right: 6 })
  }


  @Builder
  TitleDescSection() {
    Column() {
      Row() {
        Text(this.goods?.description || 'iPhone 15 Pro')
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .lineHeight(20)
      }
      .alignItems(VerticalAlign.Center)
      .width(StyleConstants.FULL_WIDTH)

      Row() {
        if (this.goods?.tag) {
          this.DescTag(this.goods.tag)
        }
        if (this.goods?.des1) {
          this.DescTag(this.goods.des1)
        }
        if (this.goods?.des2) {
          this.DescTag(this.goods.des2)
        }
      }
      .margin({ top: 8 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  DescTag(text: string) {
    Text(text)
      .fontSize(10)
      .fontColor(Color.White)
      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
      .borderRadius(10)
      .backgroundColor('#E53935')
      .margin({ right: 6 })
  }

  @Builder
  PromoTabsSection() {
    Flex({ wrap: FlexWrap.Wrap }) {
      this.PromoTab('ç²¾é€‰', true)
      this.PromoTab('é”€é‡æœ€é«˜', false)
      this.PromoTab('è¯„ä»·æœ€ä¼˜', false)
      this.PromoTab('æ–°å“ä¸Šæ¶', false)
    }
    .padding(12)
    .width(StyleConstants.FULL_WIDTH)
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  PromoTab(text: string, active: boolean) {
    Text(text)
      .fontSize(11)
      .fontColor(active ? Color.White : '#666666')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .borderRadius(14)
      .backgroundColor(active ? '#E53935' : '#F0F0F0')
  }

  @Builder
  SpecificationSection() {
    Column() {
      Text('å•†å“ä¿¡æ¯')
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .padding({ left: 12, top: 12, bottom: 8 })

      this.SpecRow('å“ç‰Œ', 'è‹¹æœ')
      this.SpecRow('å‹å·', 'iPhone 15')
      this.SpecRow('æˆè‰²', '99æ–°')
      this.SpecRow('é…ç½®', this.goods?.description || 'æœªçŸ¥')
      this.SpecRow('å”®å', '12ä¸ªæœˆä¿ä¿®')
    }
    .padding({ bottom: 12 })
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  SpecRow(label: string, value: string) {
    Column() {
      Row() {
        Text(label)
          .fontSize(12)
          .fontColor('#999999')
          .width('30%')
        Text(value)
          .fontSize(12)
          .fontColor('#333333')
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      
      Divider()
        .color('#F0F0F0')
    }
    .width('100%')
  }

  @Builder
  DeliverySection() {
    Column() {
      Text('é…é€ä¿¡æ¯')
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .padding({ left: 12, top: 12, bottom: 8 })

      this.DeliveryRow('ğŸ“', 'é€è‡³', 'åŒ—äº¬ æœé˜³åŒº')
      this.DeliveryRow('ğŸšš', 'è¿è´¹', this.goods?.shipping || 'åŒ…é‚®')
    }
    .padding({ bottom: 12 })
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  DeliveryRow(icon: string, label: string, value: string) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(12)
          .margin({ right: 4 })
        Text(label)
          .fontSize(12)
          .fontColor('#999999')
          .width('20%')
        Text(value)
          .fontSize(12)
          .fontColor('#333333')
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      
      Divider()
        .color('#F0F0F0')
    }
    .width('100%')
  }

  @Builder
  ServiceSection() {
    Column() {
      Text('æœåŠ¡ä¿éšœ')
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .padding({ left: 12, top: 12, bottom: 8 })

      Flex({ wrap: FlexWrap.Wrap }) {
        this.ServiceTag('âœ“ 7å¤©æ— ç†ç”±é€€è´§')
        this.ServiceTag('âœ“ æé€Ÿé€€æ¬¾')
        this.ServiceTag('âœ“ å®˜æ–¹è®¤è¯')
        this.ServiceTag('âœ“ å‡ä¸€èµ”ä¸‰')
        this.ServiceTag('âœ“ æ­£å“ä¿è¯')
        this.ServiceTag('âœ“ å”®åæ”¯æŒ')
      }
      .padding({ left: 12, right: 12, bottom: 12 })
    }
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  ServiceTag(text: string) {
    Text(text)
      .fontSize(11)
      .fontColor('#666666')
      .padding({ left: 8, right: 8, top: 5, bottom: 5 })
      .borderRadius(4)
      .backgroundColor('#F5F5F5')
  }


  @Builder
  QuestionsSection() {
    Column() {
      Row() {
        Text('é—®ç­”')
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
        Blank()
        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(11)
          .fontColor('#E53935')
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 12, bottom: 8 })

      Column() {
        Text('å·²ä¹°çš„æœ‹å‹ï¼Œæ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ bottom: 6 })
        Text('ç»­èˆªèƒ½åŠ›æ€ä¹ˆæ ·ï¼Ÿ')
          .fontSize(12)
          .fontColor('#666666')
      }
      .padding({ left: 12, right: 12, bottom: 12 })
      .width('100%')
    }
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  StoreSection() {
    Column() {
      Row() {
        Row() {
          Text(this.goods?.storeLevel || 'é’»çŸ³çº§')
            .fontSize(9)
            .fontColor(Color.White)
            .padding({ left: 5, right: 5, top: 1, bottom: 1 })
            .borderRadius(3)
            .backgroundColor('#FFB81C')
            .margin({ right: 6 })

          Text(this.goods?.storeName || 'çˆ±å›æ”¶ä¸¥é€‰æ‰‹æœºæ——èˆ°åº—')
            .fontSize(13)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
        }
        .layoutWeight(1)

        Row() {
          Text('è¿›åº—')
            .fontSize(11)
            .fontColor('#E53935')
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .borderRadius(4)
        .border({ color: '#E53935', width: 0.5 })
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 12, bottom: 8 })
      .alignItems(VerticalAlign.Center)

      Row() {
        this.StoreRating('è¯„åˆ†', (this.goods?.storeRating || 4.8).toFixed(1))
        this.StoreRating('ç‰©æµ', '8.7')
        this.StoreRating('å”®å', '9.6')
      }
      .width('100%')
      .padding({ left: 12, right: 12, bottom: 8 })

      Row() {
        this.StoreTag('âœ“ å®˜æ–¹è®¤è¯')
        this.StoreTag('âœ“ 7å¤©é€€è´§')
        this.StoreTag('âœ“ ' + (this.goods?.shipping || 'åŒ…é‚®'))
      }
      .width('100%')
      .padding({ left: 12, right: 12, bottom: 12 })
    }
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  StoreTag(text: string) {
    Text(text)
      .fontSize(11)
      .fontColor('#555555')
      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
      .backgroundColor('#F5F5F5')
      .borderRadius(4)
      .margin({ right: 8 })
  }

  @Builder
  StoreRating(label: string, value: string) {
    Column() {
      Text(label)
        .fontSize(11)
        .fontColor('#666666')
      Text(value)
        .fontSize(12)
        .fontColor('#333333')
        .margin({ top: 2 })
    }
    .margin({ right: 12 })
  }

  @Builder
  RecommendSection() {
    Column() {
      Text('æ¨èåˆ—è¡¨')
        .fontSize(14)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
        .padding({ left: 12, top: 4, bottom: 4 })
      Grid() {
        ForEach(this.storeGoods, (item: GoodsInfo) => {
          GridItem() {
            Column() {
              ImageKnifeView({
                loadSrc: item.imgUrl,
                objectFit: ImageFit.Fill
              })
              .width('100%')
              .height(140)
              Text(item.description || '')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 8 })
              Text(`ï¿¥${item.price || ''}`)
                .fontSize(14)
                .fontColor('#E53935')
                .fontWeight(FontWeight.Medium)
                .margin({ top: 6 })
            }
            .padding(8)
            .backgroundColor(Color.White)
            .borderRadius(6)
          }
        }, (item: GoodsInfo) => item.id.toString())
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(8)
      .columnsGap(8)
      .padding({ left: 10, right: 10, top: 8, bottom: 8 })
    }
    .backgroundColor('#F5F5F5')
    .margin({ top: 8 })
  }

  @Builder
  ActionBar() {
    Row() {
      Column() {
        Text('ğŸ‘¤')
          .fontSize(16)
        Text('å®¢æœ')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ top: 2 })
      }
      .width(50)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      Column() {
        Text('ğŸª')
          .fontSize(16)
        Text('åº—é“º')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ top: 2 })
      }
      .width(50)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      Column() {
        Text('â™¡')
          .fontSize(18)
      }
      .width(50)
      .justifyContent(FlexAlign.Center)

      // åˆ¤æ–­æ˜¯å¦æœ‰ä»·æ ¼
      if (!this.goods?.price || this.goods.price === '' || this.goods.price === '0') {
        // æ¨å¹¿ç±»å•†å“ï¼Œåªæ˜¾ç¤º"è¿›å…¥æ´»åŠ¨"æŒ‰é’®
        Button() {
          Text('è¿›å…¥æ´»åŠ¨é¡µé¢')
            .fontSize(14)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .height(40)
        .backgroundColor('#E53935')
        .borderRadius(20)
        .layoutWeight(1)
        .margin({ left: 10, right: 10 })
        .onClick(() => {
          ToastUtil.showToast('è·³è½¬åˆ°æ´»åŠ¨é¡µé¢')
        })
      } else {
        // æ™®é€šå•†å“ï¼Œæ˜¾ç¤ºåŠ è´­å’Œç«‹å³è´­ä¹°
        Button() {
          Text('åŠ å…¥è´­ç‰©è½¦')
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .height(36)
        .backgroundColor('#FF9F2E')
        .borderRadius(4)
        .layoutWeight(1)
        .margin({ left: 6, right: 4 })
        .onClick(() => {
          this.handleAddToCart(false)
        })

        Button() {
          Text('ç«‹å³è´­ä¹°')
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .height(36)
        .backgroundColor('#E53935')
        .borderRadius(4)
        .layoutWeight(1)
        .margin({ left: 4, right: 6 })
        .onClick(() => {
          this.handleAddToCart(true)
        })
      }
    }
    .width('100%')
    .height(48 + this.safeBottom)
    .alignItems(VerticalAlign.Center)
    .padding({ left: 8, right: 8, bottom: this.safeBottom })
    .backgroundColor(Color.White)
    .shadow({ radius: 8, color: '#00000020', offsetY: -2 })
    .zIndex(999)
  }

  private loadDetail() {
    this.isLoading = true
    this.loadError = ''
    queryGoodsDetail(this.goodsId).then(res => {
      this.goods = res?.goods || null
      if (!this.goods) {
        this.loadError = 'å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶'
      }
    }).catch(() => {
      this.loadError = 'å•†å“åŠ è½½å¤±è´¥'
    }).finally(() => {
      this.isLoading = false
    })
  }

  private loadStoreGoods() {
    queryStoreGoodsList(this.goodsId).then(res => {
      this.storeGoods = res?.goodsList || []
    }).catch(() => {
      this.storeGoods = []
    })
  }

  private handleAddToCart(buyNow: boolean) {
    if (!this.goodsId) {
      ToastUtil.showToast('å•†å“ä¿¡æ¯ç¼ºå¤±')
      return
    }
    const userId = AppStorage.Get<string>('userAccount') || 'guest'
    addToCart({
      userId: userId,
      goodsId: this.goodsId,
      num: 1,
      color: 'é»˜è®¤',
      size: 'é»˜è®¤',
      selected: true,
      storeCode: 'default',
      storeName: this.goods?.storeName || 'å®˜æ–¹è‡ªè¥'
    }).then(() => {
      ToastUtil.showToast(buyNow ? 'å·²åŠ å…¥è´­ç‰©è½¦ï¼Œå‰å¾€ç»“ç®—' : 'å·²åŠ å…¥è´­ç‰©è½¦')
      if (buyNow) {
        AppStorage.SetOrCreate<number>('tabIndex', 2)
        router.pushUrl({ url: 'pages/Index' })
      }
    })
  }
}
